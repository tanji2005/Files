name: Files CI (Release x64)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - 'assets/**'
      - 'builds/**'
      - 'docs/**'
      - '*.md'
  pull_request:
    paths-ignore:
      - 'assets/**'
      - 'builds/**'
      - 'docs/**'
      - '*.md'

run-name: ${{ github.event_name == 'pull_request' && 'Files PR Validation (Release x64)' || 'Files CI Validation (Release x64)' }}

env:
  SOLUTION_PATH: '${{ github.workspace }}\Files.slnx'
  PACKAGE_PROJECT_PATH: '${{ github.workspace }}\src\Files.App (Package)\Files.Package.wapproj'

  # Only build Release x64
  CONFIGURATION: 'Release'
  ARCHITECTURE: 'x64'

  # Artifacts
  ARTIFACTS_STAGING_DIR: '${{ github.workspace }}\artifacts'
  APPX_PACKAGE_DIR: '${{ github.workspace }}\artifacts\AppxPackages'
  APPX_SELFSIGNED_CERT_PATH: '${{ github.workspace }}\.github\workflows\FilesApp_SelfSigned.pfx'

  # UI test dependencies (keep for test job)
  AUTOMATED_TESTS_PROJECT_DIR: '${{ github.workspace }}\tests\Files.InteractionTests'
  AUTOMATED_TESTS_PROJECT_PATH: '${{ github.workspace }}\tests\Files.InteractionTests\Files.InteractionTests.csproj'
  AUTOMATED_TESTS_ASSEMBLY_DIR: '${{ github.workspace }}\artifacts\TestsAssembly'
  WINAPPDRIVER_EXE86_PATH: 'C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe'

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore Files
        shell: pwsh
        run: |
          msbuild $env:SOLUTION_PATH `
            -t:Restore `
            -p:Platform=$env:ARCHITECTURE `
            -p:Configuration=$env:CONFIGURATION `
            -p:PublishReadyToRun=true `
            -v:quiet

      - name: Create self signed cert as a pfx file
        shell: pwsh
        run: ./.github/scripts/Generate-SelfCertPfx.ps1 -Destination "$env:APPX_SELFSIGNED_CERT_PATH"

      - name: Build & package Files (Appx)
        shell: pwsh
        run: |
          msbuild `
            $env:PACKAGE_PROJECT_PATH `
            -t:Build `
            -t:_GenerateAppxPackage `
            -p:Configuration=$env:CONFIGURATION `
            -p:Platform=$env:ARCHITECTURE `
            -p:AppxBundlePlatforms=$env:ARCHITECTURE `
            -p:AppxBundle=Always `
            -p:UapAppxPackageBuildMode=SideloadOnly `
            -p:AppxPackageDir=$env:APPX_PACKAGE_DIR `
            -p:AppxPackageSigningEnabled=true `
            -p:PackageCertificateKeyFile=$env:APPX_SELFSIGNED_CERT_PATH `
            -p:PackageCertificatePassword="" `
            -p:PackageCertificateThumbprint="" `
            -v:quiet

      - name: Build interaction tests
        shell: pwsh
        run: |
          msbuild $env:AUTOMATED_TESTS_PROJECT_PATH `
            -t:Build `
            -p:Configuration=$env:CONFIGURATION `
            -p:Platform=$env:ARCHITECTURE `
            -v:quiet

      - name: Copy tests bin to the artifacts dir
        shell: pwsh
        run: |
          Copy-Item `
            -Path "$env:AUTOMATED_TESTS_PROJECT_DIR\bin" `
            -Destination "$env:AUTOMATED_TESTS_ASSEMBLY_DIR" -Recurse

      - name: Upload appx + test assemblies
        uses: actions/upload-artifact@v4
        with:
          name: appx-packages
          path: ${{ env.ARTIFACTS_STAGING_DIR }}

  test:
    needs: [build]
    runs-on: windows-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: appx-packages
          path: ${{ env.ARTIFACTS_STAGING_DIR }}

      - name: Install Files (from Appx bundle)
        shell: powershell
        run: |
          Set-Location "$env:APPX_PACKAGE_DIR"
          $AppxPackageBundleDir = Get-ChildItem -Filter Files.Package_*_Test -Name
          if (-not $AppxPackageBundleDir) { throw "No Files.Package_*_Test directory found under $env:APPX_PACKAGE_DIR" }
          Set-Location $AppxPackageBundleDir
          ./Install.ps1 -Force
          Get-AppxPackage | Out-Host

      - name: Set full HD resolution
        shell: pwsh
        run: Set-DisplayResolution -Width 1920 -Height 1080 -Force

      - name: Start WinAppDriver process
        shell: pwsh
        run: Start-Process -FilePath "$env:WINAPPDRIVER_EXE86_PATH"

      - name: Run interaction tests (retry once)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 2
          shell: pwsh
          command: |
            dotnet test `
              $env:AUTOMATED_TESTS_ASSEMBLY_DIR\**\Files.InteractionTests.dll `
              --logger "trx;LogFileName=$env:AUTOMATED_TESTS_ASSEMBLY_DIR\testResults.trx"
